<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>南陵祭 モバイルオーダー</title>
    <style>
      /* 
         * CSSセクション: ページの見た目を整えるスタイル定義
         */

      /* ページ全体の基本スタイル */
      body {
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN",
          "Hiragino Sans", Meiryo, sans-serif;
        max-width: 800px; /* コンテンツの最大幅を制限 */
        margin: 0 auto; /* 左右中央寄せ */
        padding: 20px; /* ページ周囲の余白 */
        background-color: #f9f9f9; /* 薄いグレーの背景 */
        color: #333; /* 文字色 */
      }

      /* 大見出しのスタイル */
      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
      }

      /* セクション見出しのスタイル */
      h2 {
        border-bottom: 2px solid #e74c3c; /* 下線を追加 */
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      /* 店舗リストを表示するコンテナのスタイル */
      #store-list {
        display: flex;
        flex-direction: column;
        gap: 15px; /* アイテム間の間隔 */
      }

      /* 各店舗情報のカードスタイル (.store-item) */
      .store-item {
        background-color: #fff;
        border: 1px solid #ddd; /* 薄い枠線 */
        border-radius: 8px; /* 角丸 */
        padding: 20px; /* 内側の余白 */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* 軽い影をつける */
        transition: transform 0.2s; /* ホバー時のアニメーション用 */
        cursor: pointer; /* クリック可能であることを示すカーソル */
      }

      /* ホバー時に少し浮き上がる演出 */
      .store-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #fafafa; /* ホバー時の背景色変更 */
      }

      /* 店舗名のスタイル (.store-name) */
      .store-name {
        font-size: 1.4em; /* フォントサイズを大きく */
        font-weight: bold;
        color: #e74c3c; /* アクセントカラー */
        margin-top: 0;
        margin-bottom: 10px;
      }

      /* 説明文のスタイル (.store-description) */
      .store-description {
        line-height: 1.6; /* 行間を広げて読みやすく */
        margin: 0;
      }

      /* 読み込み中メッセージのスタイル */
      .loading-message {
        text-align: center;
        font-size: 1.2em;
        color: #7f8c8d;
        padding: 40px 0;
      }

      /* エラーメッセージのスタイル */
      .error-message {
        color: #c0392b;
        text-align: center;
        padding: 20px;
        background-color: #fadbd8;
        border-radius: 5px;
      }

      /* --- ログイン機能用の追加スタイル --- */

      /* ログイン画面のコンテナ */
      #login-container {
        text-align: center;
        padding: 50px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-top: 50px;
      }

      /* メインコンテンツ（初期状態は非表示） */
      #main-content {
        display: none;
      }

      /* ログインボタン */
      #login-button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #login-button:hover {
        background-color: #357ae8;
      }

      /* ログアウトボタン */
      #logout-button {
        float: right;
        background-color: #95a5a6;
        color: white;
        border: none;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
        cursor: pointer;
        margin-bottom: 10px;
      }
      #logout-button:hover {
        background-color: #7f8c8d;
      }

      /* ユーザー情報表示 */
      #user-info {
        text-align: right;
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      /* --- 商品メニュー表示機能用の追加スタイル --- */

      /* 商品リストのコンテナ */
      #item-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* 商品カードのスタイル */
      .item-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        justify-content: space-between; /* 商品名と価格を左右に配置 */
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .item-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .item-price {
        font-size: 1.1em;
        color: #e74c3c;
        font-weight: bold;
      }

      /* 「店舗一覧に戻る」ボタンのスタイル */
      #back-to-stores-button {
        background-color: #ecf0f1;
        color: #2c3e50;
        border: 1px solid #bdc3c7;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 20px;
        font-size: 0.9em;
        transition: background-color 0.2s;
      }

      #back-to-stores-button:hover {
        background-color: #bdc3c7;
      }
    </style>
  </head>
  <body>
    <!-- 
     * HTMLセクション: ページの構造定義 
     -->

    <!-- ログイン画面エリア -->
    <div id="login-container">
      <h1>南陵祭 モバイルオーダー</h1>
      <p>利用するにはログインが必要です。</p>
      <button id="login-button">Googleでログイン</button>
    </div>

    <!-- メインコンテンツエリア（ログイン後に表示） -->
    <div id="main-content">
      <div id="user-info"></div>
      <button id="logout-button">ログアウト</button>

      <!-- ページ全体の大見出し -->
      <h1>南陵祭 モバイルオーダー</h1>

      <!-- ▼▼▼ 店舗一覧表示エリア ▼▼▼ -->
      <div id="store-list-container">
        <!-- 店舗一覧セクションの見出し -->
        <h2>出店一覧</h2>

        <!-- 
              JavaScriptが動的に店舗リストを挿入するための空のコンテナ要素 
            -->
        <div id="store-list"></div>
      </div>

      <!-- ▼▼▼ 商品メニュー表示エリア（初期状態は非表示） ▼▼▼ -->
      <div id="item-list-container" style="display: none">
        <!-- 店舗一覧に戻るボタン -->
        <button id="back-to-stores-button">← 店舗一覧に戻る</button>

        <!-- 選択された店舗名を表示する見出し -->
        <h2 id="selected-store-name"></h2>

        <!-- 商品リストを動的に挿入するための空のコンテナ -->
        <div id="item-list"></div>
      </div>
    </div>

    <!-- 
     * JavaScriptセクション: ロジックとFirebase連携
     -->

    <!-- 重要: Firebase SDKの読み込み (Compat版 v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- 認証機能(Auth)のSDKを追加 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
      // ▼▼▼▼ ここに自分のfirebaseConfigを貼り付ける ▼▼▼▼
      const firebaseConfig = {
        apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do",
        authDomain: "nanryosai-2026-a4091.firebaseapp.com",
        projectId: "nanryosai-2026-a4091",
        storageBucket: "nanryosai-2026-a4091.firebasestorage.app",
        messagingSenderId: "93228414556",
        appId: "1:93228414556:web:f64f90c13849fae9049899",
        measurementId: "G-1M5G95EXF0",
      };

      // Firebaseの初期化
      firebase.initializeApp(firebaseConfig);

      // FirestoreとAuthのインスタンスを取得
      const db = firebase.firestore();
      const auth = firebase.auth();

      // DOM要素の取得
      const loginContainer = document.getElementById("login-container");
      const mainContent = document.getElementById("main-content");
      const loginButton = document.getElementById("login-button");
      const logoutButton = document.getElementById("logout-button");
      const userInfoElement = document.getElementById("user-info");

      // 店舗一覧関連のDOM要素
      const storeListContainer = document.getElementById(
        "store-list-container"
      );
      const storeListElement = document.getElementById("store-list");

      // 商品一覧関連のDOM要素（新規追加）
      const itemListContainer = document.getElementById("item-list-container");
      const itemListElement = document.getElementById("item-list");
      const selectedStoreNameElement = document.getElementById(
        "selected-store-name"
      );
      const backToStoresButton = document.getElementById(
        "back-to-stores-button"
      );

      // ログインボタンのクリックイベント
      loginButton.addEventListener("click", () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
          console.error("Login failed:", error);
          alert("ログインに失敗しました: " + error.message);
        });
      });

      // ログアウトボタンのクリックイベント
      logoutButton.addEventListener("click", () => {
        auth
          .signOut()
          .then(() => {
            console.log("Signed out");
          })
          .catch((error) => {
            console.error("Sign out error", error);
          });
      });

      // 「店舗一覧に戻る」ボタンのクリックイベント（新規追加）
      backToStoresButton.addEventListener("click", () => {
        // 商品一覧を隠して、店舗一覧を表示
        itemListContainer.style.display = "none";
        storeListContainer.style.display = "block";
      });

      // 認証状態の監視
      auth.onAuthStateChanged((user) => {
        if (user) {
          // --- ログイン状態 ---
          console.log("User is signed in:", user.email);

          loginContainer.style.display = "none";
          mainContent.style.display = "block";
          userInfoElement.textContent = `ログイン中: ${
            user.displayName || user.email
          }`;

          // 店舗データの取得を開始
          fetchStoreData();
        } else {
          // --- ログアウト状態 ---
          console.log("User is signed out");

          loginContainer.style.display = "block";
          mainContent.style.display = "none";
          storeListElement.innerHTML = "";
          itemListElement.innerHTML = ""; // 商品リストもクリア
        }
      });

      // 店舗データを取得して表示する関数
      function fetchStoreData() {
        storeListElement.innerHTML =
          '<p class="loading-message">読み込み中...</p>';

        db.collection("stores")
          .get()
          .then((querySnapshot) => {
            storeListElement.innerHTML = "";

            if (querySnapshot.empty) {
              storeListElement.innerHTML =
                "<p>現在、登録されている店舗はありません。</p>";
              return;
            }

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const teamName = data.teamName ? data.teamName : "名称未設定";
              const description = data.description
                ? data.description
                : "説明はありません";
              const storeId = doc.id; // ドキュメントIDを取得

              // HTML文字列を動的に生成
              // data-store-id属性を追加して、クリック時にIDを取得できるようにする
              const storeHtml = `
                            <div class="store-item" data-store-id="${storeId}" data-store-name="${teamName}">
                                <h3 class="store-name">${teamName}</h3>
                                <p class="store-description">${description}</p>
                            </div>
                        `;
              storeListElement.innerHTML += storeHtml;
            });
          })
          .catch((error) => {
            console.error("Error getting documents: ", error);
            storeListElement.innerHTML =
              '<p class="error-message">データの取得に失敗しました。<br>権限エラーの可能性があります。</p>';
          });
      }

      // 店舗リストのクリックイベント（イベント委任）
      // 親要素であるstoreListElementにリスナーを設定し、子要素のクリックを検知する
      storeListElement.addEventListener("click", (event) => {
        // クリックされた要素が .store-item またはその子要素かを確認し、
        // .store-item 要素そのものを取得する（closestを使用）
        const storeItem = event.target.closest(".store-item");

        if (storeItem) {
          // データ属性から店舗IDと店舗名を取得
          const storeId = storeItem.dataset.storeId;
          const storeName = storeItem.dataset.storeName;

          // 商品一覧表示関数を呼び出す
          showItemsForStore(storeId, storeName);
        }
      });

      // 特定の店舗の商品メニューを表示する関数（新規追加）
      function showItemsForStore(storeId, storeName) {
        console.log(`Showing items for store: ${storeName} (ID: ${storeId})`);

        // UIの切り替え: 店舗一覧を隠し、商品一覧を表示
        storeListContainer.style.display = "none";
        itemListContainer.style.display = "block";

        // 店舗名を見出しに設定
        selectedStoreNameElement.textContent = `${storeName} のメニュー`;

        // 商品リストをクリアして読み込み中を表示
        itemListElement.innerHTML =
          '<p class="loading-message">メニューを読み込み中...</p>';

        // Firestoreから items コレクションを検索
        // where句を使って、storeIdが一致する商品のみを取得
        db.collection("items")
          .where("storeId", "==", storeId)
          .get()
          .then((querySnapshot) => {
            itemListElement.innerHTML = ""; // 読み込み中を消去

            if (querySnapshot.empty) {
              itemListElement.innerHTML =
                "<p>この店舗にはまだメニューが登録されていません。</p>";
              return;
            }

            // 取得した商品をループ処理
            querySnapshot.forEach((doc) => {
              const item = doc.data();
              const itemName = item.name ? item.name : "商品名なし";
              const itemPrice = item.price ? item.price : 0;

              // 商品カードのHTMLを生成
              const itemHtml = `
                            <div class="item-card">
                                <div class="item-name">${itemName}</div>
                                <div class="item-price">¥${itemPrice}</div>
                            </div>
                        `;
              itemListElement.innerHTML += itemHtml;
            });
          })
          .catch((error) => {
            console.error("Error getting items: ", error);
            itemListElement.innerHTML =
              '<p class="error-message">メニューの取得に失敗しました。</p>';
          });
      }
    </script>
  </body>
</html>
