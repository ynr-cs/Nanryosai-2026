<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店舗管理ポータル | 南陵祭2026</title>
    <style>
        /* 基本スタイル */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }

        /* 画面切り替え用のセクション */
        .view-section {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* カード共通スタイル */
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 480px;
            text-align: center;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        /* ログイン画面の説明文 */
        .login-step-badge {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-description {
            text-align: left;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #555;
        }

        /* ボタン共通 */
        button {
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }

        .btn-google { background-color: #db4437; }
        .btn-google:hover { background-color: #c53929; }

        .btn-add { background-color: #6610f2; }
        .btn-add:hover { background-color: #520dc2; }

        .error-message {
            color: #dc3545;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        /* ダッシュボード用 */
        #dashboard-section {
            display: none;
            padding-top: 20px;
        }

        .store-title {
            font-size: 1.5rem;
            margin: 0;
            color: #007bff;
            text-align: center;
        }
        .store-subtitle {
            text-align: center;
            color: #6c757d;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .menu-btn {
            display: block;
            text-decoration: none;
            background-color: white;
            color: #2c3e50;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: bold;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        /* 商品追加フォーム */
        .add-item-form {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
        }

        /* 商品リスト */
        .item-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        .item-row:last-child { border-bottom: none; }

        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-price { color: #666; font-size: 0.9rem; }
        .item-toppings { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .badge-recommend { 
            background: #ffc107; color: #333; 
            font-size: 0.7rem; padding: 2px 6px; 
            border-radius: 4px; margin-left: 8px; vertical-align: middle; 
        }

        .status-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-available { background-color: #d4edda; color: #155724; }
        .status-soldout { background-color: #f8d7da; color: #721c24; }

        .toggle-btn {
            width: auto;
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-bottom: 0;
        }
        .toggle-btn.btn-to-soldout { background-color: #dc3545; }
        .toggle-btn.btn-to-available { background-color: #28a745; }

        .auth-info {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 15px;
            background: #eee;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <!-- =========================
         1. Google認証セクション
    ========================== -->
    <div id="google-auth-section" class="view-section" style="display: flex;">
        <div class="login-card">
            <span class="login-step-badge">STEP 1/2</span>
            <h2>Google認証</h2>
            <div class="login-description">
                <p style="margin-top:0;">システムの安全性を確保するため、Googleアカウントによる本人確認を行います。</p>
                <p><strong>誰のアカウントを使っても構いません。</strong><br>
                （代表者個人のアカウントでも、学校のアカウントでもOKです）</p>
                <p style="margin-bottom:0; font-size:0.85rem; color:#888;">※この情報はDB接続許可のためだけに使用されます。</p>
            </div>
            <button id="googleLoginBtn" class="btn-google">Googleアカウントで認証する</button>
            <div id="googleAuthError" class="error-message"></div>
        </div>
    </div>

    <!-- =========================
         2. 店舗ログインセクション
    ========================== -->
    <div id="store-login-section" class="view-section">
        <div class="login-card">
            <span class="login-step-badge">STEP 2/2</span>
            <div class="auth-info">認証済み: <span id="userEmailDisplay"></span></div>
            <h2>店舗管理ログイン</h2>
            <div class="login-description" style="text-align: center; border: none; background: none; padding: 0 0 15px 0;">
                クラスごとの<strong>ID</strong>と<strong>パスワード</strong>を入力してください。
            </div>
            <div class="form-group">
                <label for="loginId">ログインID</label>
                <input type="text" id="loginId" placeholder="例: class101">
            </div>
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" placeholder="パスワード">
            </div>
            <button id="storeLoginBtn" class="btn-primary">ログイン</button>
            <div id="storeLoginError" class="error-message"></div>
        </div>
    </div>

    <!-- =========================
         3. ダッシュボードセクション
    ========================== -->
    <div id="dashboard-section">
        <div class="container">
            <!-- ヘッダー -->
            <div class="card header-card">
                <h1 class="store-title" id="displayStoreName">店舗名</h1>
                <p class="store-subtitle"><span id="displayTeamName"></span> (ID: <span id="displayStoreId"></span>)</p>
            </div>

            <!-- メニューリンク -->
            <h2>機能メニュー</h2>
            <div class="menu-grid">
                <a href="#" id="linkPos" class="menu-btn">POSレジ</a>
                <a href="#" id="linkKitchen" class="menu-btn">厨房画面</a>
                <a href="#" id="linkPresenter" class="menu-btn">提供口画面</a>
                <a href="#" id="linkMonitor" class="menu-btn">モニター画面</a>
                <a href="#" id="linkReport" class="menu-btn">売上レポート</a>
            </div>

            <!-- 商品追加エリア -->
            <h2>商品管理</h2>
            <div class="card add-item-form">
                <h3 style="margin-top:0; text-align:left; font-size:1.1rem;">新規商品の追加</h3>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="newItemName" placeholder="例: フランクフルト">
                </div>
                <div class="form-group">
                    <label>価格 (円)</label>
                    <input type="number" id="newItemPrice" placeholder="例: 200">
                </div>
                <div class="form-group">
                    <label>トッピング (任意・カンマ区切り)</label>
                    <input type="text" id="newItemToppings" placeholder="例: ケチャップ, マスタード">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="newItemRecommended">
                    <label for="newItemRecommended">おすすめ商品として表示する</label>
                </div>
                <button id="addItemBtn" class="btn-add">商品を追加する</button>
            </div>

            <!-- 商品リスト -->
            <h3>登録済み商品一覧</h3>
            <div class="item-list" id="itemsContainer">
                <div style="padding:20px; text-align:center; color:#999;">読み込み中...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (v9) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            onSnapshot, 
            doc, 
            updateDoc,
            addDoc
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA-Ijkbo-9rgrNKbDlRJ-rQVYdSXR_a9Do", 
            authDomain: "nanryosai-2026-a4091.firebaseapp.com",
            projectId: "nanryosai-2026-a4091",
            storageBucket: "nanryosai-2026-a4091.appspot.com",
            messagingSenderId: "360316480856",
            appId: "1:360316480856:web:1234567890abcdef" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const googleSection = document.getElementById('google-auth-section');
        const storeLoginSection = document.getElementById('store-login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleAuthError = document.getElementById('googleAuthError');
        const userEmailDisplay = document.getElementById('userEmailDisplay');

        const storeLoginBtn = document.getElementById('storeLoginBtn');
        const loginIdInput = document.getElementById('loginId');
        const passwordInput = document.getElementById('password');
        const storeLoginError = document.getElementById('storeLoginError');

        // Dashboard Display Elements
        const displayStoreName = document.getElementById('displayStoreName');
        const displayTeamName = document.getElementById('displayTeamName');
        const displayStoreId = document.getElementById('displayStoreId');
        const itemsContainer = document.getElementById('itemsContainer');

        // Add Item Form Elements
        const newItemName = document.getElementById('newItemName');
        const newItemPrice = document.getElementById('newItemPrice');
        const newItemToppings = document.getElementById('newItemToppings');
        const newItemRecommended = document.getElementById('newItemRecommended');
        const addItemBtn = document.getElementById('addItemBtn');

        // Link Elements
        const links = {
            pos: document.getElementById('linkPos'),
            kitchen: document.getElementById('linkKitchen'),
            presenter: document.getElementById('linkPresenter'),
            monitor: document.getElementById('linkMonitor'),
            report: document.getElementById('linkReport')
        };

        let currentStoreId = null; // ログイン中の店舗IDを保持

        // ==========================================
        //  1. Google認証
        // ==========================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Google Auth Success:", user.email);
                userEmailDisplay.textContent = user.email;
                googleSection.style.display = 'none';
                storeLoginSection.style.display = 'flex';
            } else {
                dashboardSection.style.display = 'none';
                storeLoginSection.style.display = 'none';
                googleSection.style.display = 'flex';
            }
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                googleAuthError.textContent = "認証エラー: " + error.message;
            }
        });

        // ==========================================
        //  2. 店舗ログイン
        // ==========================================
        storeLoginBtn.addEventListener('click', async () => {
            const inputId = loginIdInput.value.trim();
            const inputPass = passwordInput.value.trim();

            if (!inputId || !inputPass) return;

            storeLoginError.textContent = "確認中...";
            
            try {
                const q = query(collection(db, "stores"), where("loginId", "==", inputId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    storeLoginError.textContent = "IDが見つかりません";
                    return;
                }

                const storeDoc = querySnapshot.docs[0];
                const storeData = storeDoc.data();

                if (String(storeData.password) === String(inputPass)) {
                    currentStoreId = storeDoc.id; // Store IDを保存
                    initDashboard(currentStoreId, storeData);
                } else {
                    storeLoginError.textContent = "パスワードが違います";
                }

            } catch (error) {
                console.error("Login Error:", error);
                storeLoginError.textContent = "エラー: " + error.message;
            }
        });

        // ==========================================
        //  3. ダッシュボード初期化
        // ==========================================
        function initDashboard(storeId, storeData) {
            storeLoginSection.style.display = 'none';
            dashboardSection.style.display = 'block';

            displayStoreName.textContent = storeData.name;
            displayTeamName.textContent = storeData.teamName;
            displayStoreId.textContent = storeId;

            // 各ページへのリンク設定
            links.pos.href = `pos.html?storeId=${storeId}`;
            links.kitchen.href = `kitchen.html?storeId=${storeId}`;
            links.presenter.href = `presenter.html?storeId=${storeId}`;
            links.monitor.href = `monitor.html?storeId=${storeId}`;
            links.report.href = `sales-report.html?storeId=${storeId}`;

            startItemListener(storeId);
        }

        // ==========================================
        //  4. 商品一覧の表示とステータス切り替え
        // ==========================================
        function startItemListener(storeId) {
            const q = query(collection(db, "items"), where("storeId", "==", storeId));

            onSnapshot(q, (snapshot) => {
                itemsContainer.innerHTML = "";
                if (snapshot.empty) {
                    itemsContainer.innerHTML = '<div style="padding:20px; text-align:center;">商品がありません。上のフォームから追加してください。</div>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const item = docSnap.data();
                    const itemId = docSnap.id;
                    const isAvailable = item.isAvailable === true;

                    // 行コンテナ
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'item-row';

                    // 商品情報
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'item-info';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'item-name';
                    nameDiv.innerHTML = `${item.name} <span style="font-size:0.9rem;">(¥${item.price})</span>`;
                    
                    // おすすめバッジ
                    if (item.isRecommended) {
                        const recBadge = document.createElement('span');
                        recBadge.className = 'badge-recommend';
                        recBadge.textContent = 'おすすめ';
                        nameDiv.appendChild(recBadge);
                    }
                    
                    infoDiv.appendChild(nameDiv);

                    // トッピング表示
                    if (item.allowedToppings && item.allowedToppings.length > 0) {
                        const toppingsDiv = document.createElement('div');
                        toppingsDiv.className = 'item-toppings';
                        toppingsDiv.textContent = 'トッピング: ' + item.allowedToppings.join(', ');
                        infoDiv.appendChild(toppingsDiv);
                    }

                    // コントロール
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'status-controls';

                    const badgeSpan = document.createElement('span');
                    badgeSpan.className = `status-badge ${isAvailable ? 'status-available' : 'status-soldout'}`;
                    badgeSpan.textContent = isAvailable ? '販売中' : '売切';

                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = `toggle-btn ${isAvailable ? 'btn-to-soldout' : 'btn-to-available'}`;
                    toggleBtn.textContent = isAvailable ? '売切にする' : '販売再開';
                    
                    toggleBtn.onclick = async () => {
                        try {
                            const itemRef = doc(db, "items", itemId);
                            await updateDoc(itemRef, { isAvailable: !isAvailable });
                        } catch (err) {
                            alert("更新失敗: " + err.message);
                        }
                    };

                    controlsDiv.appendChild(badgeSpan);
                    controlsDiv.appendChild(toggleBtn);

                    rowDiv.appendChild(infoDiv);
                    rowDiv.appendChild(controlsDiv);

                    itemsContainer.appendChild(rowDiv);
                });
            });
        }

        // ==========================================
        //  5. 商品の追加処理 (Add Item)
        // ==========================================
        addItemBtn.addEventListener('click', async () => {
            const name = newItemName.value.trim();
            const priceStr = newItemPrice.value.trim();
            const toppingsStr = newItemToppings.value.trim();
            const isRecommended = newItemRecommended.checked;

            if (!name || !priceStr) {
                alert("商品名と価格は必須です");
                return;
            }

            if (!currentStoreId) {
                alert("店舗IDが不明です。再ログインしてください。");
                return;
            }

            // トッピング文字列を配列に変換 ("A, B, C" -> ["A", "B", "C"])
            let toppingsArray = [];
            if (toppingsStr) {
                toppingsArray = toppingsStr.split(',')
                    .map(t => t.trim())
                    .filter(t => t.length > 0);
            }

            addItemBtn.disabled = true;
            addItemBtn.textContent = "追加中...";

            try {
                // itemsコレクションに追加
                await addDoc(collection(db, "items"), {
                    name: name,
                    price: parseInt(priceStr, 10),
                    storeId: currentStoreId,
                    isAvailable: true, // デフォルトで販売中
                    isRecommended: isRecommended,
                    allowedToppings: toppingsArray
                });

                // フォームをクリア
                newItemName.value = "";
                newItemPrice.value = "";
                newItemToppings.value = "";
                newItemRecommended.checked = false;
                alert("商品を追加しました！");

            } catch (error) {
                console.error("Add Item Error:", error);
                alert("追加に失敗しました: " + error.message);
            } finally {
                addItemBtn.disabled = false;
                addItemBtn.textContent = "商品を追加する";
            }
        });

    </script>
</body>
</html>